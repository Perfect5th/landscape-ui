import{r as x,j as e,d as r,F as j,z as k,B as T,w as N,C as $,am as b,m as te,f as ae,bl as se,x as y,V as q,i as D,l as A,a4 as ne,Q as v,aY as oe}from"./index-DldVyDB7.js";import{A as M}from"./AssociationBlock-BrA3HF5v.js";import{S as O}from"./SidePanelFormButtons-BXpt2VOg.js";import{u as Q}from"./useRoles-BcDGeixi.js";import{T as re,C as W,a as E,E as z,u as F,V as ie,I as le,b as ce,L as U,c as ue,d as de,P as pe,e as ge,f as me}from"./index-bWE4MbJj.js";import{g as Et,h as Rt,i as Dt}from"./index-bWE4MbJj.js";import{F as he}from"./FileInput-DQu2FUT-.js";import{u as Pe}from"./useGetInstances-CMxGcBq1.js";import{H as Y}from"./HeaderWithSearch-Dw5YrX_c.js";import{S as K}from"./SidePanelTablePagination-D_JtMxJP.js";import{P as Ce}from"./ProfileAssociatedInstancesLink-DQisdfox.js";import"./MultiSelectField-BmF_pj5b.js";import"./useGetTags-s2JyFrpp.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./PageMain-BQl0O8qo.js";import"./constants-BXId--Uu.js";import"./constants-kFYhfhH2.js";import"./table-CdFwMAPu.js";const R=({onChange:t,value:a,...s})=>{const[n,o]=x.useState(a);return e.jsx(r.Input,{type:"text",autoComplete:"off",...s,value:n,onChange:i=>{o(i.target.value)},onBlur:()=>t(n)})},be="_action_w93bw_1",xe="_cell_w93bw_7",fe="_input_w93bw_18",je="_inputWrapper_w93bw_26",S={action:be,cell:xe,input:fe,inputWrapper:je},Se=async(t,a,s,n)=>{await t.setFieldValue(`constraints[${a}]${[s]}`,n),await t.setFieldTouched(`constraints[${a}]${[s]}`,!0),["rule","version"].includes(s)&&(n!==""?await t.setFieldValue(`constraints[${a}].notAnyVersion`,!0):t.values.constraints[a][s==="rule"?"version":"rule"]===""&&await t.setFieldValue(`constraints[${a}].notAnyVersion`,!1))},ye=(t,a,s)=>{if(!t.errors.constraints?.[a]||!t.touched.constraints?.[a]?.[s])return;const n=t.errors.constraints[a];return typeof n!="string"?n[s]:void 0},_e=async(t,a)=>{await t.setFieldValue("constraints",t.values.constraints.filter((s,n)=>n!==a)),t.touched.constraints&&(t.touched.constraints.splice(a,1),await t.setTouched({...t.touched,constraints:t.touched.constraints}))},ve=t=>({handleConstraintPropChange:async(a,s,n)=>{await Se(t,a,s,n)},handleConstraintRowDelete:async a=>{await _e(t,a)},getConstraintsErrorByIndex:(a,s)=>ye(t,a,s)}),Ne=({column:t})=>{const a={};return a.className=S.cell,t.id==="package_name"?a.role="rowheader":t.id==="action"?a["aria-label"]="Action":t.id==="constraint"?a["aria-label"]="Constraint":t.id==="version"?a["aria-label"]="Version":t.id==="rule"&&(a["aria-label"]="Rule"),a},Z=({formik:t})=>{x.useEffect(()=>{t.submitCount!==0&&(async()=>await t.setTouched({...t.touched,constraints:new Array(t.values.constraints.length).fill(re)}))()},[t.submitCount]);const a=x.useMemo(()=>t.values.constraints,[t.values.constraints]),{handleConstraintPropChange:s,handleConstraintRowDelete:n,getConstraintsErrorByIndex:o}=ve(t),i=x.useMemo(()=>[{accessor:"constraint",Header:"Constraint",Cell:({row:{index:c}})=>e.jsx(r.Select,{label:"Constraint",labelClassName:"u-off-screen",className:S.input,wrapperClassName:S.inputWrapper,options:W,...t.getFieldProps(`constraints[${c}].constraint`),onChange:u=>s(c,"constraint",u.target.value),error:o(c,"constraint")})},{accessor:"package",Header:"Package",Cell:({row:{index:c}})=>e.jsx(R,{placeholder:"Package name",label:"Package name",labelClassName:"u-off-screen",className:S.input,wrapperClassName:S.inputWrapper,...t.getFieldProps(`constraints[${c}].package`),onChange:u=>s(c,"package",u),error:o(c,"package")})},{accessor:"rule",Header:"Rule",Cell:({row:{index:c}})=>e.jsx(r.Select,{label:"Rule",labelClassName:"u-off-screen",className:S.input,wrapperClassName:S.inputWrapper,...t.getFieldProps(`constraints[${c}].rule`),options:E,onChange:u=>s(c,"rule",u.target.value),error:o(c,"rule")})},{accessor:"version",Header:"Version",Cell:({row:{index:c}})=>e.jsx(R,{placeholder:"Version",label:"Version",labelClassName:"u-off-screen",className:S.input,wrapperClassName:S.inputWrapper,...t.getFieldProps(`constraints[${c}].version`),onChange:u=>s(c,"version",u),error:o(c,"version")})},{accessor:"action",className:S.action,Cell:({row:c})=>e.jsx(r.Button,{type:"button",hasIcon:!0,appearance:"base",className:"u-no-margin--bottom u-no-padding","aria-label":"Delete constraint row",onClick:()=>n(c.index),children:e.jsx(r.Icon,{name:r.ICONS.delete,className:"u-no-margin--left u-no-margin--right"})})}],[a,t.errors.constraints,t.touched.constraints]),g=async()=>{if(await t.setFieldValue("constraints",[z,...t.values.constraints]),t.touched.constraints){const c=[];for(let u=t.values.constraints.length;u>0;u--)t.touched.constraints[u-1]&&(c[u]=t.touched.constraints[u-1]);await t.setTouched({constraints:c})}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"u-align-text--right",children:e.jsxs(r.Button,{type:"button",hasIcon:!0,onClick:g,children:[e.jsx(r.Icon,{name:r.ICONS.plus,className:"u-no-margin--left"}),e.jsx("span",{children:"Add new constraint"})]})}),e.jsx(r.ModularTable,{columns:i,data:a,getCellProps:Ne,emptyMsg:"No constraints added yet.",className:"u-no-margin--bottom"}),t.touched.constraints&&typeof t.errors.constraints=="string"&&e.jsx("div",{className:"is-error",children:e.jsxs("p",{className:"p-form-validation__message u-no-margin--top",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:t.errors.constraints})]})})]})},Fe=[{label:"Select constraints type",value:""},{label:"From an instance's packages",value:"instance"},{label:"From a CSV file",value:"material"},{label:"Enter manually",value:"manual"}],Ae="_container_vi1gw_1",ke={container:Ae},Te=({formik:t})=>{const{instances:a}=Pe(),s=a.map(({id:i,title:g})=>({label:g,value:`${i}`}))??[];s.unshift({label:"Select instance",value:""});const n=async i=>{await t.setFieldValue("csvFile",i[0]);const g=await i[0].text();await t.setFieldValue("material",g)},o=async()=>{await t.setFieldValue("csvFile",null),await t.setFieldValue("material",""),await t.setFieldValue("isCsvFileParsed",!1)};return e.jsxs("div",{className:ke.container,children:[e.jsx(r.Select,{label:"Package constraints",required:!0,options:Fe,...t.getFieldProps("constraintsType"),error:j(t,"constraintsType")}),t.values.constraintsType==="instance"&&e.jsx(r.Select,{label:"Instance",required:t.values.constraintsType==="instance",options:s,...t.getFieldProps("source_computer_id"),error:j(t,"source_computer_id")}),t.values.constraintsType==="material"&&e.jsx(he,{label:"Upload constraints",accept:".csv",...t.getFieldProps("csvFile"),onFileRemove:o,onFileUpload:n,help:'File should be formatted as either a package profile CSV file or the output of running "dpkg --get-selections" on a computer with desired packages installed.',error:j(t,"csvFile")||j(t,"material")||void 0}),t.values.constraintsType==="manual"&&e.jsx(Z,{formik:t})]})},At=()=>{const t=k(),{notify:a}=T(),{createPageParamsSetter:s}=N(),{getAccessGroupQuery:n}=Q(),{createPackageProfileQuery:o}=F(),{data:i,isPending:g}=n(),c=i?.data.map(({name:m,title:h})=>({label:h,value:m}))??[],{mutateAsync:u}=o,p=s({sidePath:[],profile:""}),d=$({initialValues:le,onSubmit:async m=>{const h={access_group:m.access_group,description:m.description,title:m.title};m.all_computers?h.all_computers=!0:m.tags.length>0&&(h.tags=m.tags),m.constraintsType==="material"?h.material=m.material:m.constraintsType==="instance"?h.source_computer_id=m.source_computer_id:h.constraints=m.constraints.map(({constraint:l,package:C,rule:w,version:L})=>({constraint:l,package:C,rule:w,version:L}));try{await u(h),p(),a.success({message:`Profile "${m.title}" added successfully`,title:"Profile added"})}catch(l){t(l)}},validationSchema:ie,validateOnMount:!0});return g?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsx(b.Header,{children:"Add package profile"}),e.jsx(b.Content,{children:e.jsxs(r.Form,{onSubmit:d.handleSubmit,noValidate:!0,children:[e.jsx(r.Input,{type:"text",label:"Title",required:!0,...d.getFieldProps("title"),error:j(d,"title")}),e.jsx(r.Input,{type:"text",label:"Description",required:!0,autoComplete:"off",...d.getFieldProps("description"),error:j(d,"description")}),e.jsx(r.Select,{label:"Access group",...d.getFieldProps("access_group"),options:c,error:j(d,"access_group")}),e.jsx(M,{formik:d}),e.jsx(Te,{formik:d}),e.jsx(O,{submitButtonDisabled:!d.isValid,submitButtonLoading:d.isSubmitting,submitButtonText:"Add package profile",onCancel:p})]})})]})},we=t=>{const a=te(),{data:s,isPending:n,error:o}=ae({queryKey:["packageProfile",t],queryFn:async({signal:g})=>a.get("packageprofiles",{params:{names:[t]},signal:g})}),i=s?.data.result[0];return{packageProfile:i,packageProfileError:s&&!i?new Error("The package profile could not be found."):o,isGettingPackageProfile:n}},I=()=>{const{profile:t}=N(),{packageProfile:a,isGettingPackageProfile:s,packageProfileError:n}=we(t);if(n)throw n;return s?{packageProfile:void 0,isGettingPackageProfile:!0}:{packageProfile:a,isGettingPackageProfile:!1}},$e=({profile:t})=>{const a=x.useContext(se),s=k(),{notify:n}=T(),{sidePath:o,popSidePath:i}=N(),{addPackageProfileConstraintsQuery:g}=F(),{mutateAsync:c}=g,p=$({initialValues:{constraints:[z]},onSubmit:async({constraints:P})=>{try{await c({name:t.name,constraints:P.map(({constraint:d,package:m,rule:h,version:l})=>({constraint:d,package:m,rule:h,version:l}))}),i(),n.success({message:`${P.length} package profile ${y(P.length,"constraint")}  added successfully`,title:"Package profile constraints added"})}catch(d){s(d)}},validationSchema:ce,validateOnMount:!0});return e.jsxs(r.Form,{onSubmit:p.handleSubmit,noValidate:!0,children:[e.jsx(Z,{formik:p}),e.jsx(O,{submitButtonDisabled:!p.isValid||p.isValidating,submitButtonLoading:p.isSubmitting,submitButtonText:`Add ${y(p.values.constraints.length,"constraint")}`,submitButtonAriaLabel:`Add ${y(p.values.constraints.length,"constraint")} to "${t.title}" profile`,cancelButtonDisabled:p.isSubmitting,hasBackButton:o.length>1,onBackButtonPress:i,onCancel:a})]})},kt=()=>{const{packageProfile:t,isGettingPackageProfile:a}=I();return a?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:['Add package constraints to "',t.title,'" profile']}),e.jsx(b.Content,{children:e.jsx($e,{profile:t})})]})},Ie=[{label:"All",value:""},{label:"Conflicts",value:"conflicts"},{label:"Depends",value:"depends"}],Be="_container_scrq4_1",Ve={container:Be},Ee=({filter:t,formik:a,onFilterChange:s,profile:n,selectedIds:o,setSelectedIds:i})=>{const g=k(),{notify:c}=T(),{createSidePathPusher:u}=N(),{removePackageProfileConstraintsQuery:p}=F(),{mutateAsync:P,isPending:d}=p,m=async()=>{try{await P({constraint_ids:o,name:n.name}),i([]),c.success({message:`${o.length} "${n.title}" profile's ${y(o.length,"constraint")} removed successfully`,title:`Package profile ${y(o.length,"constraint")} removed`})}catch(l){g(l)}},h=u("add-constraints");return e.jsxs("div",{className:Ve.container,children:[e.jsx(r.Select,{label:"Constraint type",className:"u-no-margin--bottom",labelClassName:"u-no-padding--top",options:Ie,value:t,onChange:l=>{s(l.target.value)}}),e.jsxs(r.ConfirmationButton,{className:"has-icon u-no-margin--right u-no-margin--bottom",type:"button",disabled:o.length===0||a.values.id!==0,"aria-label":`Remove selected ${y(o.length,"constraint")}`,confirmationModalProps:{title:`Remove ${y(o.length,"constraint")}`,children:e.jsxs("p",{children:["This will remove ",o.length," ",y(o.length,"constraint"),"."]}),confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:d,confirmButtonLoading:d,onConfirm:m},children:[e.jsx(r.Icon,{name:r.ICONS.delete}),e.jsx("span",{children:"Remove"})]}),e.jsxs(r.Button,{className:"u-no-margin--bottom",type:"button",hasIcon:!0,onClick:h,"aria-label":"Add new constraint",children:[e.jsx(r.Icon,{name:r.ICONS.plus}),e.jsx("span",{children:"Add constraints"})]})]})},Re="_actionButton_15xpu_1",De="_tooltip_15xpu_5",V={actionButton:Re,tooltip:De},Oe=({constraint:t,formik:a})=>a.values.id===t.id?e.jsxs(e.Fragment,{children:[e.jsx(r.Button,{type:"button",appearance:"base",hasIcon:!0,className:q("u-no-margin--bottom u-no-padding",V.actionButton),onClick:()=>{a.handleSubmit()},"aria-label":`Save changes to ${t.package} constraint`,children:e.jsx(r.Tooltip,{tooltipClassName:V.tooltip,message:"Save changes",children:e.jsx(r.Icon,{name:"success-grey",className:"u-no-margin--left u-no-margin--right"})})}),e.jsx(r.Button,{type:"button",appearance:"base",hasIcon:!0,className:"u-no-margin--bottom u-no-padding",onClick:()=>{a.resetForm()},"aria-label":`Cancel editing ${t.package} constraint`,children:e.jsx(r.Tooltip,{tooltipClassName:V.tooltip,message:"Cancel",children:e.jsx(r.Icon,{name:"error-grey",className:"u-no-margin--left u-no-margin--right"})})})]}):e.jsx(r.Button,{type:"button",appearance:"base",hasIcon:!0,className:"u-no-margin--bottom u-no-padding",onClick:()=>a.setValues(t),disabled:a.values.id!==0,"aria-label":`Edit ${t.package} constraint`,children:e.jsx(r.Tooltip,{tooltipClassName:V.tooltip,message:"Edit constraint",children:e.jsx(r.Icon,{name:"edit",className:"u-no-margin--left u-no-margin--right"})})}),Le="_actionsCell_1kvjf_1",He="_noPadding_1kvjf_7",Ge="_cell_1kvjf_11",Me="_input_1kvjf_23",Qe="_inputWrapper_1kvjf_31",We="_hidden_1kvjf_37",f={actionsCell:Le,noPadding:He,cell:Ge,input:Me,inputWrapper:Qe,hidden:We},qe=async(t,a,s)=>{await t.setFieldValue(`${a}`,s),await t.setFieldTouched(`${a}`,!0),["rule","version"].includes(`${a}`)&&(s!==""?await t.setFieldValue("notAnyVersion",!0):t.values[a==="rule"?"version":"rule"]===""&&await t.setFieldValue("notAnyVersion",!1))},ze=(t,a)=>{if(!(!t.touched[a]||!t.errors[a]))return t.errors[a]},Ue=t=>({handleConstraintPropChange:(a,s)=>qe(t,a,s),getConstraintPropError:a=>ze(t,a)}),Ye=({column:t,row:a},s)=>{const n={};return n.className=q(f.cell,{[f.noPadding]:a.original.id===s}),a.original.package==="loading"?t.id==="package"?n.colSpan=5:(n.className=f.hidden,n["aria-hidden"]=!0):t.id==="package"?n.role="rowheader":t.id==="actions"?n["aria-label"]="Actions":t.id==="constraint"?n["aria-label"]="Constraint":t.id==="version"?n["aria-label"]="Version":t.id==="rule"&&(n["aria-label"]="Rule"),n},Ke=(t,a)=>{let s="No constraints found";return t&&(s+=` with the constraint type: "${t}"`,a&&(s+=" and")),a&&(s+=` with the search: "${a}"`),s},Ze=({filter:t,formik:a,isConstraintsLoading:s,onSelectedIdsChange:n,pageSize:o,profileConstraints:i,search:g,selectedIds:c})=>{const u=x.useMemo(()=>{if(s)return[U];if(!i)return[];const l=i.map(C=>({...C,notAnyVersion:!!C.version}));return a.values.id!==-1?l:[a.values,...l].slice(0,o)},[s,i,a.values,o]),p=()=>{n(c.length?[]:u.map(({id:l})=>l))},P=l=>{c.includes(l)?n(c.filter(C=>C!==l)):n([...c,l])},{handleConstraintPropChange:d,getConstraintPropError:m}=Ue(a),h=x.useMemo(()=>[{accessor:"constraint",Header:()=>e.jsxs(e.Fragment,{children:[e.jsx(r.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:"Toggle all constraints"}),labelClassName:"u-no-margin--bottom u-no-padding--top",disabled:a.values.id!==0||u.length===0,checked:u.length>0&&u.length===c.length,indeterminate:c.length>0&&c.length<u.length,onChange:p}),e.jsx("span",{children:"Constraint"})]}),Cell:({row:{original:l}})=>a.values.id===l.id?e.jsx(r.Select,{label:"Constraint",labelClassName:"u-off-screen",className:f.input,wrapperClassName:f.inputWrapper,options:W,...a.getFieldProps("constraint"),onChange:C=>d("constraint",C.target.value),error:m("constraint")}):e.jsxs("div",{className:f.checkboxContainer,children:[e.jsx(r.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${l.package} constraint`}),labelClassName:"u-no-margin--bottom u-no-padding--top",disabled:a.values.id!==0,checked:c.includes(l.id),onChange:()=>{P(l.id)}}),e.jsx("span",{children:l.constraint})]})},{accessor:"package",Header:"Package",Cell:({row:{original:l}})=>a.values.id===l.id?e.jsx(R,{placeholder:"Package name",label:"Package name",labelClassName:"u-off-screen",className:f.input,wrapperClassName:f.inputWrapper,...a.getFieldProps("package"),onChange:C=>d("package",C),error:m("package")}):l.package!=="loading"?e.jsx(e.Fragment,{children:l.package}):e.jsx(D,{})},{accessor:"rule",Header:"Rule",Cell:({row:{original:l}})=>a.values.id===l.id?e.jsx(r.Select,{label:"Rule",labelClassName:"u-off-screen",className:f.input,wrapperClassName:f.inputWrapper,options:E,...a.getFieldProps("rule"),onChange:C=>d("rule",C.target.value),error:m("rule")}):e.jsx(e.Fragment,{children:E.find(({value:C})=>C===l.rule)?.label??l.rule})},{accessor:"version",Header:"Version",Cell:({row:{original:l}})=>a.values.id===l.id?e.jsx(R,{placeholder:"Version",label:"Version",labelClassName:"u-off-screen",className:f.input,wrapperClassName:f.inputWrapper,...a.getFieldProps("version"),onChange:C=>d("version",C),error:m("version")}):e.jsx(e.Fragment,{children:l.version})},{accessor:"actions",className:f.actionsCell,Cell:({row:{original:l}})=>e.jsx(Oe,{constraint:l,formik:a})}],[u,c.length,a.errors,a.touched]);return e.jsx(r.ModularTable,{columns:h,data:u,getCellProps:l=>Ye(l,a.values.id),className:"u-no-margin--bottom",emptyMsg:Ke(t,g)})},Je="_pagination_15tqa_1",Xe={pagination:Je},et=({profile:t})=>{const[a,s]=x.useState([]),[n,o]=x.useState(1),[i,g]=x.useState(A),[c,u]=x.useState(""),[p,P]=x.useState(""),d=_=>{s([]),o(_)},m=_=>{s([]),g(_)},h=k(),{notify:l}=T(),{editPackageProfileConstraintQuery:C,getPackageProfileConstraintsQuery:w}=F(),{mutateAsync:L}=C,H=$({initialValues:de,onSubmit:async(_,{resetForm:X})=>{try{await L({constraint:_.constraint,id:_.id,package:_.package,rule:_.rule,version:_.version,name:t.name}),l.success({message:`"${t.title}" package profile's constraint updated successfully`,title:"Package profile constraint updated"}),X()}catch(ee){h(ee)}},validationSchema:ue}),{data:B,isLoading:G}=w({constraint_type:p||void 0,limit:i,name:t.name,offset:(n-1)*i,search:c});return e.jsxs(e.Fragment,{children:[!c&&!p&&n===1&&i===A&&G&&e.jsx(D,{}),(c||p||n!==1||i!==A||!G&&B&&B.data.results.length>0)&&e.jsxs(e.Fragment,{children:[e.jsx(Y,{actions:e.jsx(Ee,{filter:p,formik:H,onFilterChange:P,profile:t,selectedIds:a,setSelectedIds:s}),onSearch:u,disabled:H.values.id!==0}),e.jsx(Ze,{filter:p,formik:H,isConstraintsLoading:G,onSelectedIdsChange:s,pageSize:i,profileConstraints:B?.data.results,search:c,selectedIds:a}),e.jsx(K,{currentPage:n,pageSize:i,paginate:d,setPageSize:m,totalItems:B?.data.count,className:Xe.pagination})]})]})},Tt=()=>{const{packageProfile:t,isGettingPackageProfile:a}=I();return a?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:['Change "',t.title,`" profile's constraints`]}),e.jsx(b.Content,{children:e.jsx(et,{profile:t})})]})},tt="_constraint_1lz67_1",at="_hidden_1lz67_5",J={constraint:tt,hidden:at},st=({row:t,column:a})=>{const s={};return t.original.package==="loading"?a.id==="package"?s.colSpan=3:(s.className=J.hidden,s["aria-hidden"]=!0):a.id==="package"?s.role="rowheader":a.id==="constraint"?s["aria-label"]="Constraint":a.id==="rule"?s["aria-label"]="Rule":a.id==="version"&&(s["aria-label"]="Version"),s},nt=({isConstraintsLoading:t,profileConstraints:a,search:s})=>{const n=x.useMemo(()=>t?[U]:a?a.map(i=>({...i,notAnyVersion:!!i.version})):[],[t,a]),o=x.useMemo(()=>[{accessor:"constraint",className:J.constraint,Header:"Constraint",Cell:({row:{original:i}})=>W.find(({value:g})=>g===i.constraint)?.label??i.constraint},{accessor:"package",Header:"Package",Cell:({row:{original:i}})=>i.package==="loading"?e.jsx(D,{}):i.package},{accessor:"version",Header:"Version",Cell:({row:{original:i}})=>i.version?`${E.find(({value:g})=>g===i.rule)?.label} ${i.version}`:"Any"}],[n]);return e.jsx(r.ModularTable,{columns:o,data:n,getCellProps:st,emptyMsg:`No constraints found with the search: "${s}"`})},ot="_actions_nxngq_1",rt={actions:ot},it=({profile:t})=>{const[a,s]=x.useState(1),[n,o]=x.useState(A),[i,g]=x.useState(""),{createSidePathPusher:c}=N(),{getPackageProfileConstraintsQuery:u}=F(),{data:p,isLoading:P}=u({name:t.name,limit:n,offset:(a-1)*n,search:i}),d=c("edit-constraints");return e.jsxs(e.Fragment,{children:[!i&&a===1&&n===A&&P&&e.jsx(D,{}),(i||a!==1||n!==A||!P&&p&&p.data.results.length>0)&&e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:rt.actions,onSearch:g,actions:e.jsx(r.Button,{className:"u-no-margin--bottom",type:"button",onClick:d,children:"Change package constraints"})}),e.jsx(nt,{isConstraintsLoading:P,profileConstraints:p?.data.results,search:i}),e.jsx(K,{currentPage:a,pageSize:n,paginate:s,setPageSize:o,totalItems:p?.data.count})]})]})},wt=()=>{const{createSidePathPusher:t}=N(),{getAccessGroupQuery:a}=Q(),{data:s,isPending:n}=a(),{packageProfile:o,isGettingPackageProfile:i}=I(),{value:g,setTrue:c,setFalse:u}=ne();if(i||n)return e.jsx(b.LoadingState,{});const p=t("edit"),P=t("duplicate");return e.jsxs(e.Fragment,{children:[e.jsx(b.Header,{children:o.title}),e.jsxs(b.Content,{children:[e.jsxs("div",{className:"p-segmented-control",children:[e.jsxs(r.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button u-no-margin",onClick:P,children:[e.jsx(r.Icon,{name:"canvas"}),e.jsx("span",{children:"Duplicate profile"})]}),e.jsxs(r.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button u-no-margin",onClick:p,children:[e.jsx(r.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(r.Button,{className:"p-segmented-control__button u-no-margin",hasIcon:!0,type:"button",onClick:c,"aria-label":`Remove ${o.title} package profile`,children:[e.jsx(r.Icon,{name:r.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]}),e.jsxs(v,{spaced:!0,children:[e.jsx(v.Item,{label:"Title",value:o.title}),e.jsx(v.Item,{label:"Name",value:o.name}),e.jsx(v.Item,{label:"Description",value:o.description}),e.jsx(v.Item,{label:"Access group",value:oe(o.access_group,s)}),e.jsx(v.Item,{label:"Tags",large:!0,value:o.tags.join(", "),type:"truncated"}),e.jsx(v.Item,{label:"Associated to",value:e.jsx(Ce,{profile:o,count:o.computers.constrained.length,query:`package:${o.id}`})}),e.jsx(v.Item,{label:"Pending on",value:`${o.computers.pending?.length??0} ${y(o.computers.pending.length,"instance")}`}),e.jsx(v.Item,{label:"Not compliant on",value:`${o.computers["non-compliant"].length} ${y(o.computers["non-compliant"].length,"instance")}`})]}),e.jsx(it,{profile:o})]}),e.jsx(pe,{close:u,isOpen:g,packageProfile:o})]})},lt=({profile:t})=>{const a=k(),{sidePath:s,popSidePath:n,createPageParamsSetter:o}=N(),{notify:i}=T(),{getAccessGroupQuery:g}=Q(),{copyPackageProfileQuery:c}=F(),{mutateAsync:u}=c,{data:p}=g(),P=p?.data.map(({name:l,title:C})=>({label:C,value:l}))??[],d=o({sidePath:[],profile:""}),m=async l=>{const C={all_computers:l.all_computers,access_group:l.access_group,copy_from:t.name,description:l.description,title:l.title};!l.all_computers&&l.tags.length>0&&(C.tags=l.tags);try{await u(C),d(),i.success({message:`Profile "${t.title}" duplicated successfully`,title:"Profile duplicated"})}catch(w){a(w)}},h=$({initialValues:{access_group:t.access_group,all_computers:t.all_computers,description:t.description,tags:t.tags,title:`${t.title} (copy)`},onSubmit:m,validationSchema:ge});return e.jsxs(r.Form,{onSubmit:h.handleSubmit,noValidate:!0,children:[e.jsx(r.Input,{type:"text",label:"Title",required:!0,...h.getFieldProps("title"),error:j(h,"title")}),e.jsx(r.Input,{type:"text",label:"Description",required:!0,autoComplete:"off",...h.getFieldProps("description"),error:j(h,"description")}),e.jsx(r.Select,{label:"Access group",...h.getFieldProps("access_group"),options:P,error:j(h,"access_group")}),e.jsx(M,{formik:h}),e.jsx(O,{submitButtonLoading:h.isSubmitting,submitButtonText:"Duplicate",hasBackButton:s.length>1,onBackButtonPress:n,onCancel:d})]})},$t=()=>{const{packageProfile:t,isGettingPackageProfile:a}=I();return a?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:["Duplicate ",t.title]}),e.jsx(b.Content,{children:e.jsx(lt,{profile:t})})]})},ct=({profile:t})=>{const a=k(),{sidePath:s,popSidePath:n,createPageParamsSetter:o}=N(),{notify:i}=T(),{editPackageProfileQuery:g}=F(),{mutateAsync:c}=g,u=o({sidePath:[],profile:""}),p=async d=>{try{await c({...d,name:t.name,tags:d.all_computers?[]:d.tags}),u(),i.success({message:`Package profile "${t.title}" updated successfully`,title:"Package profile updated"})}catch(m){a(m)}},P=$({enableReinitialize:!0,initialValues:{all_computers:t.all_computers,description:t.description,tags:t.tags,title:t.title},onSubmit:p,validationSchema:me});return e.jsxs(r.Form,{onSubmit:P.handleSubmit,noValidate:!0,children:[e.jsx(r.Input,{type:"text",label:"Title",...P.getFieldProps("title"),error:j(P,"title")}),e.jsx(r.Input,{type:"text",label:"Description",...P.getFieldProps("description")}),e.jsx(M,{formik:P}),e.jsx(O,{submitButtonLoading:P.isSubmitting,submitButtonText:"Save changes",hasBackButton:s.length>1,onBackButtonPress:n,onCancel:u})]})},It=()=>{const{packageProfile:t,isGettingPackageProfile:a}=I();return a?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:["Edit ",t.title]}),e.jsx(b.Content,{children:e.jsx(ct,{profile:t})})]})};export{At as PackageProfileAddSidePanel,kt as PackageProfileConstraintsAddSidePanel,Tt as PackageProfileConstraintsEditSidePanel,wt as PackageProfileDetailsSidePanel,$t as PackageProfileDuplicateSidePanel,It as PackageProfileEditSidePanel,Et as PackageProfileHeader,Rt as PackageProfileList,Dt as PackageProfilesEmptyState,F as usePackageProfiles};
