import{t as K,m as W,s as R,v as f,f as T,z as k,B as D,r as A,C as H,H as L,W as $,o as z,j as e,d as o,F as V,ac as B,b as q,aM as U,V as Y,aa as _,i as G}from"./index-BANqK6Vn.js";import{P as J,a as O,b as X}from"./PageMain-CPivTSLH.js";import{d as Z,s as j}from"./constants-GGztYKoV.js";import{M as ee}from"./MultiSelectField-t015LGjx.js";import{u as se}from"./useGetTags-DpwHb5kW.js";import"./constants-D3vKocNj.js";const F=s=>s?"Yes":"No";function S(){const s=K(),a=W(),n=R(),c=()=>T({queryKey:["alert"],queryFn:async()=>a.get("alerts")}),u=f({mutationKey:["alert","subscribe"],mutationFn:async i=>n.get("SubscribeToAlert",{params:i}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})}),m=f({mutationKey:["alert","unsubscribe"],mutationFn:async i=>n.get("UnsubscribeFromAlert",{params:i}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})}),d=f({mutationKey:["alert","associate"],mutationFn:async i=>n.get("AssociateAlert",{params:i}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})}),r=f({mutationKey:["alert","disassociate"],mutationFn:async i=>n.get("DisassociateAlert",{params:i}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})});return{getAlertsQuery:c,subscribeQuery:u,unsubscribeQuery:m,associateAlert:d,disassociateAlert:r}}const te="_footer_1qn3u_1",ae="_multiSelect_1qn3u_7",E={footer:te,multiSelect:ae},M=(s,a)=>{const n=new Set(a);return s.filter(c=>!n.has(c))},Q=({alert:s,availableTagOptions:a})=>{const n=k(),{notify:c}=D(),{associateAlert:u,disassociateAlert:m}=S(),d=A.useRef(null),{mutateAsync:r}=u,{mutateAsync:i}=m,g=s.all_computers?["All"]:s.tags,C=async({tags:l})=>{try{const p=M(s.tags,l),h=M(l,s.tags),w=l.includes("All"),P=s.all_computers&&!w;if(w)await r({name:s.alert_type,tags:void 0,all_computers:!0});else if(P)await Promise.all([r({name:s.alert_type,tags:l.filter(x=>x!=="All"),all_computers:!1}),i({name:s.alert_type,all_computers:!0})]);else{const x=[];h.length>0&&x.push(r({name:s.alert_type,tags:h,all_computers:!1})),p.length>0&&x.push(i({name:s.alert_type,tags:p,all_computers:!1})),await Promise.all(x)}c.success({title:"Alert tags updated",message:`You changed ${s.label}'s tags`})}catch(p){n(p)}},t=H({initialValues:{tags:g},validationSchema:L().shape({tags:$().of(z())}),onSubmit:C}),y=t.values.tags.includes("All")?a.filter(({value:l})=>l!=="All"):void 0,v=t.values.tags.includes("All")?a:a.filter(({value:l})=>t.values.tags.includes(l)),I=l=>{const p=l.some(({value:h})=>h==="All")?["All"]:l.map(({value:h})=>h);t.setValues({tags:p})};A.useEffect(()=>{const l=d.current?.querySelector(".multi-select__condensed-text");l&&l.textContent.includes("All instances")&&(l.textContent="All instances")},[t.values.tags]);const N=()=>t.isSubmitting?!0:g.length===t.values.tags.length&&g.every(l=>t.values.tags.includes(l));return e.jsx(o.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:e.jsx(ee,{innerRef:d,required:!0,variant:"condensed",className:E.multiSelect,items:a,selectedItems:v,disabledItems:y,onItemsUpdate:I,placeholder:"Select tags",error:V(t,"tags"),dropdownFooter:e.jsxs("div",{className:E.footer,children:[e.jsx(o.Button,{type:"button",dense:!0,small:!0,className:"u-no-margin--bottom",disabled:N(),onClick:()=>t.setFieldValue("tags",g),children:"Revert"}),e.jsx(o.Button,{type:"button",dense:!0,small:!0,appearance:"positive",className:"u-no-margin--bottom",disabled:N(),onClick:()=>t.submitForm(),children:"Save changes"})]})})})},le="_noWrap_1ld5g_19",ne="_alertsWrapper_1ld5g_23",ce="_emailColumn_1ld5g_31",re="_nameColumn_1ld5g_35",ie="_tags_1ld5g_39",b={switch:"_switch_1ld5g_1",noWrap:le,alertsWrapper:ne,emailColumn:ce,nameColumn:re,tags:ie},oe=s=>{const a={};switch(s.column.id){case"label":a.role="rowheader";break;case"subscribed":a["aria-label"]="Email";break;case"tags":a["aria-label"]="Tags";break;case"description":a["aria-label"]="Description";break}return a},ue=({alerts:s,availableTagOptions:a})=>{const n=B("(min-width: 620px)"),c=k(),{unsubscribeQuery:u,subscribeQuery:m}=S(),{user:d}=q(),{mutateAsync:r}=m,{mutateAsync:i}=u,g=async t=>{const y=t.subscribed?i:r;try{await y({alert_type:t.alert_type})}catch(v){c(v)}},C=A.useMemo(()=>[{accessor:"label",className:b.nameColumn,Header:"Name"},{Header:e.jsxs("div",{className:b.noWrap,children:[e.jsx("span",{children:"Email "}),d&&e.jsx(o.Tooltip,{position:"btm-left",message:`Enabling email notifications will send alerts to ${d.email}, associated with your account`,children:e.jsx(o.Icon,{name:"help"})})]}),accessor:"subscribed",className:b.emailColumn,Cell:({row:t})=>e.jsx("div",{className:b.switch,children:e.jsx(o.Switch,{label:F(t.original.subscribed),defaultChecked:t.original.subscribed,onChange:()=>g(t.original)})})},{accessor:"tags",Header:"Enabled for",className:b.tags,Cell:({row:{original:t}})=>e.jsx(Q,{alert:t,availableTagOptions:a})},{Header:"Description",accessor:"description",Cell:({row:{original:t}})=>e.jsx(e.Fragment,{children:t.description})}],[s]);return n?e.jsx(U,{columns:C,data:s,getCellProps:oe,emptyMsg:"No data available"}):s.map((t,y)=>e.jsxs(o.Row,{className:Y("u-no-padding--left u-no-padding--right",b.alertsWrapper),children:[e.jsx(o.Col,{size:2,small:2,children:e.jsx(_,{label:"Name",value:t.label})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(_,{label:"Email",value:e.jsx("div",{className:b.switch,children:e.jsx(o.Switch,{label:F(t.subscribed),defaultChecked:t.subscribed,onChange:()=>g(t)})})})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(_,{label:"Enabled for",value:e.jsx(Q,{alert:t,availableTagOptions:a})})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(_,{label:"Description",value:t.description})})]},y))},de=({alerts:s,availableTagOptions:a})=>{const{user:n}=q(),c=n?.accounts.find(u=>u.name===n.current_account);return e.jsx("div",{className:Z.item,children:e.jsxs("div",{className:j.card,children:[e.jsx("div",{className:j.header,children:e.jsx("p",{className:j.title,children:c?.title||"Alerts"})}),e.jsx("div",{className:j.content,children:e.jsx(ue,{alerts:s,availableTagOptions:a})})]})})},xe=()=>{const{getAlertsQuery:s}=S(),{tags:a}=se(),{data:n,isLoading:c}=s(),u=A.useMemo(()=>n?.data.filter(r=>!r.alert_type.toUpperCase().includes("LICENSE"))??[],[n]),m=a.map(r=>({label:r,value:r,group:"Tags"}))??[],d=[{label:"All instances",value:"All"},...m];return e.jsxs(J,{children:[e.jsx(O,{title:"Alerts"}),e.jsxs(X,{children:[c&&e.jsx(G,{}),!c&&u&&e.jsx(de,{alerts:u,availableTagOptions:d})]})]})};export{xe as default};
